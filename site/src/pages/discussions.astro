---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Discussions">
  <div class="space-y-6">
    <div>
      <h1 class="text-4xl font-bold mb-2">GitHub Discussions</h1>
      <p class="text-base-content/70">
        Community discussions and conversations
      </p>
    </div>

    <!-- Search and Filter -->
    <div class="flex gap-4 flex-wrap">
      <input 
        type="text" 
        id="search-input"
        placeholder="Search discussions..." 
        class="input input-bordered flex-1 min-w-[200px]"
      />
      <a href="https://github.com/cywf/willow/discussions/new" target="_blank" class="btn btn-primary">
        New Discussion
      </a>
    </div>

    <!-- Loading State -->
    <div id="discussions-loading" class="space-y-4">
      {[1, 2, 3].map(() => (
        <div class="card bg-base-200 shadow-xl">
          <div class="card-body">
            <div class="skeleton h-6 w-3/4 mb-2"></div>
            <div class="skeleton h-4 w-full mb-2"></div>
            <div class="skeleton h-4 w-2/3"></div>
          </div>
        </div>
      ))}
    </div>

    <!-- Discussions List -->
    <div id="discussions-list" class="hidden space-y-4">
      <!-- Will be populated by JavaScript -->
    </div>

    <!-- Empty State -->
    <div id="discussions-empty" class="hidden text-center py-12">
      <svg class="w-24 h-24 mx-auto text-base-content/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
      </svg>
      <h2 class="text-2xl font-bold mt-4">No Discussions Found</h2>
      <p class="text-base-content/70 mt-2">
        Be the first to start a discussion!
      </p>
      <a href="https://github.com/cywf/willow/discussions/new" target="_blank" class="btn btn-primary mt-4">
        Start Discussion
      </a>
    </div>

    <!-- Error State -->
    <div id="discussions-error" class="hidden alert alert-error">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <div>
        <h3 class="font-bold">Error Loading Discussions</h3>
        <div class="text-sm">Unable to load discussions data. Please try again later.</div>
      </div>
    </div>
  </div>
</Layout>

<script>
  interface Discussion {
    title: string;
    url: string;
    author: string;
    createdAt: string;
    category: string;
    comments: number;
    answerChosen?: boolean;
  }

  let allDiscussions: Discussion[] = [];

  async function loadDiscussions() {
    const loading = document.getElementById('discussions-loading');
    const list = document.getElementById('discussions-list');
    const empty = document.getElementById('discussions-empty');
    const error = document.getElementById('discussions-error');

    try {
      const baseUrl = import.meta.env.BASE_URL || '/willow';
      const response = await fetch(`${baseUrl}/data/discussions.json`);
      
      if (!response.ok) {
        throw new Error('Failed to fetch discussions');
      }

      allDiscussions = await response.json();
      
      if (loading) loading.classList.add('hidden');
      
      if (allDiscussions.length === 0) {
        if (empty) empty.classList.remove('hidden');
      } else {
        if (list) {
          list.classList.remove('hidden');
          renderDiscussions(allDiscussions);
        }
      }
    } catch (err) {
      console.error('Error loading discussions:', err);
      if (loading) loading.classList.add('hidden');
      if (error) error.classList.remove('hidden');
    }
  }

  function renderDiscussions(discussions: Discussion[]) {
    const list = document.getElementById('discussions-list');
    if (!list) return;

    if (discussions.length === 0) {
      list.innerHTML = `
        <div class="text-center py-8 text-base-content/70">
          No discussions match your search.
        </div>
      `;
      return;
    }

    list.innerHTML = discussions.map(discussion => `
      <div class="card bg-base-200 shadow-xl hover:shadow-2xl transition-shadow">
        <div class="card-body">
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1">
              <h3 class="card-title">
                <a href="${discussion.url}" target="_blank" class="link link-hover">
                  ${discussion.title}
                </a>
              </h3>
              <div class="flex gap-4 mt-2 text-sm text-base-content/70 flex-wrap">
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                  </svg>
                  ${discussion.author}
                </span>
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                  </svg>
                  ${new Date(discussion.createdAt).toLocaleDateString()}
                </span>
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/>
                  </svg>
                  ${discussion.comments} comments
                </span>
              </div>
            </div>
            <div class="flex flex-col gap-2 items-end">
              <span class="badge badge-primary badge-sm">${discussion.category}</span>
              ${discussion.answerChosen ? '<span class="badge badge-success badge-sm">Answered</span>' : ''}
            </div>
          </div>
        </div>
      </div>
    `).join('');
  }

  function setupSearch() {
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    if (!searchInput) return;

    searchInput.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.toLowerCase();
      const filtered = allDiscussions.filter(d => 
        d.title.toLowerCase().includes(query) ||
        d.category.toLowerCase().includes(query) ||
        d.author.toLowerCase().includes(query)
      );
      renderDiscussions(filtered);
    });
  }

  // Initialize
  loadDiscussions();
  setupSearch();
</script>
